<link rel="import" href="../components/firebase-element/firebase-element.html">
<link rel="import" href="../components/more-param/more-param.html">
<link rel="import" href="../components/more-routing/more-route.html">
<link rel="import" href="../components/polymer/polymer.html">

<link rel="import" href="pending-commit.html">

<polymer-element name="pending-commits" attributes="firebaseApp" fit>
  <template>
    <style>
      :host {
        overflow: auto;
      }

      pending-commit {
        cursor: pointer;
      }
    </style>

    <more-route id="route" name="commit-details" params="{{params}}"></more-route>
    <firebase-element location="https://{{firebaseApp}}.firebaseio.com/queue" data="{{commits}}" keys="{{keys}}"></firebase-element>

    <template repeat="{{key in keys}}">
      <!-- TODO(nevir): Why can't we bind to params.foo? -->
      <pending-commit
        commit="{{commits[key]}}"
        firebaseApp="{{firebaseApp}}"
        selected?="{{commitMatches(commits[key], $.route.params.user, $.route.params.repo, $.route.params.sha)}}"
        on-tap="{{onItemSelected}}">
      </pending-commit>
    </template>
  </template>

  <script>
    Polymer('pending-commits', {
      queueKeysChanged: function() {
        var seen = {};
        this.commits = [];
        this.queueKeys.forEach(function(queueKey) {
          var commit = this.queue[queueKey];
          var key = this.commitKey(commit);
          if (key in seen) return;
          seen[key] = true;
          this.commits.push(commit);
        }.bind(this));

        this.async(this.updateSelection);
      },

      commitKey: function(commit) {
        return commit.user + '/' + commit.repo + '/' + commit.sha;
      },

      onItemSelected: function(event, index, node) {
        this.$.route.navigateTo(node.commit);
      },

      commitMatches: function(commit) {
        return this.$.route.isCurrentUrl(commit);
      },
    });
  </script>
</polymer-element>
