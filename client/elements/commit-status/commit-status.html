<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/firebase-element/firebase-element.html">
<link rel="import" href="../../components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../components/core-tooltip/core-tooltip.html">
<link rel="import" href="../../components/core-splitter/core-splitter.html">
<link rel="import" href="../log-entries/log-entries.html">

<polymer-element name="commit-status" layout vertical attributes="firebaseApp user repo sha">
  <template>
    <style>
      .pass {
        background-color: #2baf2b;
      }
      .fail {
        background-color: #e84e40;
      }

      .tab > * {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        padding: 0 5px;
        text-align: center;
      }
      .tab .result {
        font-size: 0.8em;
      }
      .image {
        background-size: contain;
        background-repeat: no-repeat;
        background-position: top center;
      }
      .info {
        width: 30%;
        padding: 20px;
      }
      .info > * {
        margin-bottom: 10px;
      }

      log-entries {
        margin-right: 1em;
      }
    </style>

    <firebase-element location="https://{{firebaseApp}}.firebaseio.com/status/{{user}}/{{repo}}/{{sha}}/platforms"
      data="{{results}}" auto?="{{sha}}" on-data-change="{{resultsChanged}}"></firebase-element>
    <firebase-element location="https://{{firebaseApp}}.firebaseio.com/status/{{user}}/{{repo}}/{{sha}}"
      data="{{status}}" auto?="{{sha}}" on-data-change="{{resultsChanged}}"></firebase-element>

    <core-toolbar class="toolbar">
      <div hidden?="{{!status.pending}}">Tests in progress...</div>
      <div hidden?="{{!status.error}}">Error occurred running tests</div>
    </core-toolbar>

    <paper-tabs selected="{{selected}}" class="tabs">
      <paper-tab class="tab status">
        Status
      </paper-tab>
      <template repeat="{{resultsArray}}">
        <paper-tab class="tab {{ {fail: !passed, pass: passed} | tokenList }}">
          <core-tooltip label="{{platform}}">
            <div>{{platform}}</div>
          </core-tooltip>
          <div class="result">{{passed ? 'Passed' : 'Failed'}}</div>
        </paper-tab>
      </template>
    </paper-tabs>

    <div flex layout horizontal hidden?="{{selected == 0 || !resultsArray[selected]}}">
      <div class="info">
        <template repeat="{{resultsArray[selected].reports}}">
          <p style="font-weight:bold;">{{name}}</p>
          <em>Message</em>
          <code><pre>{{message}}</pre></code>
          <div hidden?="{{!stack}}">
            <em>Stack</em>
            <code><pre>{{stack}}</pre></code>
          </div>
          <hr>
        </template>
      </div>
      <core-splitter direction="left"></core-splitter>
      <div class="image" flex style="background-image:url({{resultsArray[selected].image}});"></div>
    </div>

    <log-entries entries="{{status.log}}" hidden?="{{selected != 0}}"></log-entries>
  </template>
  <script>
    Polymer({
      selected: 0,
      resultsChanged: function() {
        var results = [];
        for (var i in this.results) {
          results.push(this.results[i]);
        }
        this.resultsArray = results;
      }
    });
  </script>
</polymer-element>
