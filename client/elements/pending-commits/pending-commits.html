<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/firebase-element/firebase-element.html">
<!-- <link rel="import" href="../../components/core-list/core-list.html"> -->

<link rel="import" href="pending-commit.html">

<polymer-element name="pending-commits" attributes="firebaseApp user repo sha">
  <template>
    <style>
      pending-commit {
        cursor: pointer;
      }
    </style>

    <firebase-element location="https://{{firebaseApp}}.firebaseio.com/queue" data="{{commits}}" keys="{{keys}}"></firebase-element>

    <template repeat="{{key in keys}}">
      <pending-commit
        commit="{{commits[key]}}"
        firebaseApp="{{firebaseApp}}"
        selected?="{{commitMatches(commits[key], user, repo, sha)}}"
        on-tap="{{onItemSelected}}">
      </pending-commit>
    </template>
  </template>

  <script>
    Polymer('pending-commits', {
      observe: {
        user: 'updateSelection',
        repo: 'updateSelection',
        sha:  'updateSelection',
      },

      queueKeysChanged: function() {
        var seen = {};
        this.commits = [];
        this.queueKeys.forEach(function(queueKey) {
          var commit = this.queue[queueKey];
          var key = this.commitKey(commit);
          if (key in seen) return;
          seen[key] = true;
          this.commits.push(commit);
        }.bind(this));

        this.async(this.updateSelection);
      },

      commitKey: function(commit) {
        return commit.user + '/' + commit.repo + '/' + commit.sha;
      },

      onItemSelected: function(event, index, node) {
        var commit = node.commit;
        this.user = commit.user;
        this.repo = commit.repo;
        this.sha  = commit.sha;
      },

      commitMatches: function(commit, user, repo, sha) {
        return commit.user === user && commit.repo === repo && commit.sha === sha;
      },
    });
  </script>
</polymer-element>
