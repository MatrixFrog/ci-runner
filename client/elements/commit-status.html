<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../components/core-splitter/core-splitter.html">
<link rel="import" href="../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../components/core-tooltip/core-tooltip.html">
<link rel="import" href="../components/firebase-element/firebase-element.html">
<link rel="import" href="../components/more-param/more-param.html">
<link rel="import" href="../components/paper-tabs/paper-tabs.html">
<link rel="import" href="../components/polymer/polymer.html">

<link rel="import" href="log-entries.html">

<polymer-element name="commit-status" layout vertical fit attributes="firebaseApp user repo sha">
  <template>
    <style>
      .pass {
        background-color: #2baf2b;
      }
      .fail {
        background-color: #e84e40;
      }

      .tab > * {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        padding: 0 5px;
        text-align: center;
      }
      .tab .result {
        font-size: 0.8em;
      }

      #content {
        overflow: auto;
      }

      log-entries {
        margin-right: 1em;
      }

      .image {
        background-size: contain;
        background-repeat: no-repeat;
        background-position: top center;
      }
      .info {
        width: 30%;
        padding: 20px;
      }
      .info > * {
        margin-bottom: 10px;
      }
    </style>

    <!--
    TODO(nevir): It sucks to have to redefine this everywhere. I'd like to be
    able to just pass it in - but template contexts don't inherit, so that's
    getting rather painful.
    -->
    <more-param key="firebase_app" value="{{firebaseApp}}" default="polymer-ci"></more-param>
    <firebase-element location="https://{{firebaseApp}}.firebaseio.com/status/{{user}}/{{repo}}/{{sha}}/platforms"
      data="{{results}}" on-data-change="{{resultsChanged}}"></firebase-element>
    <firebase-element location="https://{{firebaseApp}}.firebaseio.com/status/{{user}}/{{repo}}/{{sha}}"
      data="{{status}}" on-data-change="{{resultsChanged}}"></firebase-element>

    <paper-tabs selected="{{selected}}" class="tabs">
      <paper-tab class="tab log">
        Run Log
      </paper-tab>
      <template repeat="{{resultsArray}}">
        <paper-tab class="tab {{ {fail: !passed, pass: passed} | tokenList }}">
          <core-tooltip label="{{platform}}">
            <div>{{platform}}</div>
          </core-tooltip>
          <div class="result">{{passed ? 'Passed' : 'Failed'}}</div>
        </paper-tab>
      </template>
    </paper-tabs>

    <section id="content" flex>
      <log-entries entries="{{status.log}}" hidden?="{{selected != 0}}"></log-entries>

      <div layout horizontal hidden?="{{selected == 0 || !resultsArray[selected]}}">
        <div class="info">
          <template repeat="{{resultsArray[selected].reports}}">
            <p style="font-weight:bold;">{{name}}</p>
            <em>Message</em>
            <code><pre>{{message}}</pre></code>
            <div hidden?="{{!stack}}">
              <em>Stack</em>
              <code><pre>{{stack}}</pre></code>
            </div>
            <hr>
          </template>
        </div>
        <core-splitter direction="left"></core-splitter>
        <div class="image" flex style="background-image:url({{resultsArray[selected].image}});"></div>
      </div>
    </section>
  </template>
  <script>
    Polymer({
      selected: 0,
      resultsChanged: function() {
        var results = [];
        for (var i in this.results) {
          results.push(this.results[i]);
        }
        this.resultsArray = results;
      }
    });
  </script>
</polymer-element>
